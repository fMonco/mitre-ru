



Кража или подделка билетов Kerberos
========================================


Злоумышленники могут попытаться подорвать аутентификацию Kerberos, украв или подделав билеты Kerberos, чтобы включить функцию Pass the Ticket. Kerberos - это протокол аутентификации, широко используемый в современных доменных средах Windows. В средах Kerberos, называемых "царствами", есть три основных участника: клиент, сервис и центр распределения ключей. Клиенты запрашивают доступ к сервису и через обмен билетами Kerberos, исходящими от KDC, получают доступ после успешной аутентификации. KDC отвечает как за аутентификацию, так и за выдачу билетов. Злоумышленники могут попытаться злоупотребить Kerberos, украв билеты или подделав их для получения несанкционированного доступа.


В Windows для просмотра и анализа кэшированных билетов Kerberos можно использовать встроенную утилиту klist.


Linux-системы в доменах Active Directory хранят учетные данные Kerberos локально в файле кэша учетных данных, называемом "ccache". Учетные данные хранятся в файле ccache, пока они остаются действительными и, как правило, пока длится сеанс пользователя. В современных системах Redhat Enterprise Linux и производных дистрибутивах, System Security Services Daemon обрабатывает билеты Kerberos. По умолчанию SSSD хранит копию базы данных билетов, которая находится в файле /var/lib/sss/secrets/secrets.ldb, а также соответствующий ключ, расположенный в файле /var/lib/sss/secrets/.secrets.mkey. Для чтения обоих файлов требуется доступ root. Если противнику удастся получить доступ к базе данных и ключу, кэш Kerberos может быть извлечен и преобразован в пригодный для использования файл Kerberos ccache, который противник может использовать для передачи билета. Файл ccache также может быть преобразован в формат Windows с помощью таких инструментов, как Kekeo.


Билеты Kerberos в macOS хранятся в стандартном формате ccache, как и в Linux. По умолчанию доступ к этим записям ccache осуществляется через процесс демона KCM по протоколу Mach RPC, который использует окружение вызывающей стороны для определения доступа. Место хранения этих записей ccache зависит от конфигурационного файла /etc/krb5.conf и переменной окружения KRB5CCNAME, которая может указывать, сохранять их на диск или держать их защищенными через демон KCM. Пользователи могут взаимодействовать с хранилищем билетов с помощью встроенных двоичных файлов kinit, klist, ktutil и kcc или с помощью встроенного фреймворка Kerberos от Apple. Злоумышленники могут использовать инструменты с открытым исходным кодом для прямого взаимодействия с файлами ccache или использовать фреймворк Kerberos для вызова API более низкого уровня для извлечения TGT или сервисных билетов пользователя.



Золотой билет
----------------------------------------------------------------------------


Злоумышленники, обладающие хэшем пароля учетной записи KRBTGT, могут подделать билеты Kerberos, также известные как золотые билеты. Золотые билеты позволяют злоумышленникам генерировать материал для проверки подлинности любой учетной записи в Active Directory.

Используя золотой билет, злоумышленники могут запросить билеты службы предоставления билетов, которые открывают доступ к определенным ресурсам. Золотые билеты требуют от противников взаимодействия с центром распределения ключей для получения TGS.

Служба KDC работает на контроллерах домена, входящих в домен Active Directory. KRBTGT - это учетная запись службы Kerberos Key Distribution Center, которая отвечает за шифрование и подписание всех билетов Kerberos. Хэш пароля KRBTGT можно получить с помощью OS Credential Dumping и привилегированного доступа к контроллеру домена.



Серебряный билет
----------------------------------------------------------------------------


Злоумышленники, обладающие хэшем пароля целевой учетной записи службы, могут подделать билеты Kerberos ticket granting service, также известные как серебряные билеты. Билеты TGS Kerberos также известны как служебные билеты.

Серебряные билеты имеют более ограниченную область применения, чем золотые билеты, поскольку они позволяют злоумышленникам получить доступ только к определенному ресурсу и системе, на которой расположен ресурс; однако, в отличие от золотых билетов, злоумышленники, способные подделывать серебряные билеты, могут создавать TGS-билеты без взаимодействия с центром распределения ключей, что потенциально затрудняет обнаружение.

Хеши паролей для целевых сервисов могут быть получены с помощью OS Credential Dumping или Kerberoasting.



Кербероастинг
----------------------------------------------------------------------------


Злоумышленники могут злоупотребить действительным билетом Kerberos или прослушать сетевой трафик, чтобы получить билет службы предоставления билетов, который может быть уязвим для брутфорса.

Имена принципалов служб используются для уникальной идентификации каждого экземпляра службы Windows. Для обеспечения аутентификации Kerberos требует, чтобы SPN были связаны по крайней мере с одной учетной записью входа в службу.

Противники, обладающие действительным Kerberos ticket-granting ticket, могут запросить один или несколько служебных билетов Kerberos ticket-granting service для любого SPN у контроллера домена.  Части этих билетов могут быть зашифрованы с помощью алгоритма RC4, что означает, что хэш Kerberos 5 TGS-REP etype 23 учетной записи службы, связанной с SPN, используется в качестве закрытого ключа и, таким образом, уязвим для автономных атак методом грубой силы, которые могут раскрыть учетные данные в открытом виде.

Аналогичное поведение может быть реализовано с использованием служебных билетов, перехваченных из сетевого трафика.



Обжарка AS-REP
----------------------------------------------------------------------------

Злоумышленники могут раскрыть учетные данные учетных записей, в которых отключена предварительная аутентификация Kerberos, путем взлома сообщений Kerberos с помощью пароля.

Предварительная аутентификация обеспечивает защиту от автономного взлома паролей. Когда она включена, пользователь, запрашивающий доступ к ресурсу, начинает взаимодействие с контроллером домена, отправляя сообщение Authentication Server Request с меткой времени, зашифрованное хэшем его пароля. Если и только если DC сможет успешно расшифровать временную метку с хэшем пароля пользователя, он отправит сообщение Authentication Server Response, содержащее билет на предоставление билета пользователю. Часть сообщения AS-REP подписывается паролем пользователя.

Для каждой учетной записи, найденной без предварительной аутентификации, злоумышленник может отправить сообщение AS-REQ без зашифрованной метки времени и получить сообщение AS-REP с данными TGT, которые могут быть зашифрованы с помощью небезопасного алгоритма, например RC4. Восстановленные зашифрованные данные могут быть уязвимы для автономных атак взлома пароля, аналогично Kerberoasting, и раскрывать учетные данные в открытом тексте. 

Учетная запись, зарегистрированная в домене, с особыми привилегиями или без них, может быть использована для получения списка всех учетных записей домена, в которых отключена предварительная аутентификация, с помощью таких инструментов Windows, как PowerShell с LDAP-фильтром. В качестве альтернативы злоумышленник может отправить сообщение AS-REQ для каждого пользователя. Если DC отвечает без ошибок, то учетной записи не требуется предварительная аутентификация, и сообщение AS-REP уже будет содержать зашифрованные данные. 