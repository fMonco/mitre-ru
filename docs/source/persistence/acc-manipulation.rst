



Манипуляции с учетными записями
=============================================

Недоброжелатели могут манипулировать учетными записями, чтобы сохранить и/или расширить доступ к системам жертвы. Манипуляции с учетными записями могут включать в себя любые действия, сохраняющие или изменяющие доступ противника к взломанной учетной записи, например изменение учетных данных или групп разрешений. Эти действия также могут включать в себя действия с учетными записями, направленные на нарушение политик безопасности, например, итеративное обновление пароля для обхода политик длительности пароля и сохранения срока действия скомпрометированных учетных данных.

Чтобы создавать или манипулировать учетными записями, противник должен обладать достаточными правами на системы или домен. Однако манипуляции с учетными записями могут также привести к повышению привилегий, когда изменения предоставляют доступ к дополнительным ролям, разрешениям или более высоким привилегированным учетным записям Valid Accounts.







Дополнительные облачные учетные данные
------------------------------------------------------------------------

Злоумышленники могут добавлять контролируемые злоумышленниками учетные данные в облачную учетную запись, чтобы сохранить постоянный доступ к учетным записям и экземплярам жертвы в среде.

Например, злоумышленники могут добавлять учетные данные для Service Principals и Applications в дополнение к существующим законным учетным данным в Azure AD. Эти учетные данные включают как ключи x509, так и пароли. При наличии достаточных прав существует множество способов добавления учетных данных, включая Azure Portal, интерфейс командной строки Azure, а также модули Azure или Az PowerShell.

В средах инфраструктура-как-сервис (IaaS) после получения доступа через облачные учетные записи злоумышленники могут генерировать или импортировать собственные SSH-ключи с помощью API CreateKeyPair или ImportKeyPair в AWS или команды gcloud compute os-login ssh-keys add в GCP. Это позволяет получить постоянный доступ к экземплярам в облачной среде без дальнейшего использования скомпрометированных облачных учетных записей.

Злоумышленники также могут использовать API CreateAccessKey в AWS или команду gcloud iam service-accounts keys create в GCP для добавления ключей доступа к учетной записи. Если целевая учетная запись имеет разрешения, отличные от запрашивающей учетной записи, злоумышленник также может повысить свои привилегии в среде (т. е. в облачных учетных записях). Например, в среде Azure AD злоумышленник с ролью администратора приложений может добавить новый набор учетных данных к принципалу службы своего приложения. При этом злоумышленник сможет получить доступ к ролям и разрешениям принципала службы, которые могут отличаться от ролей и разрешений администратора приложения.

В средах AWS злоумышленники с соответствующими полномочиями могут также использовать вызов API sts:GetFederationToken для создания временного набора учетных данных, привязанных к полномочиям исходной учетной записи пользователя. Эти учетные данные могут оставаться действительными в течение всего срока их действия, даже если учетные данные API исходной учетной записи деактивированы.







Дополнительные полномочия делегирования электронной почты
------------------------------------------------------------------


Недоброжелатели могут предоставлять дополнительные уровни разрешений, чтобы сохранить постоянный доступ к контролируемой ими учетной записи электронной почты.


Недоброжелатели также могут назначать разрешения папок почтовых ящиков с помощью отдельных разрешений или ролей папок. В средах Office 365 злоумышленники могут назначить разрешения или роли пользователей "По умолчанию" или "Аноним" для папок Top of Information Store (root), Inbox или других почтовых ящиков. Назначив одно или оба пользовательских разрешения папке, злоумышленник может использовать любую другую учетную запись в арендаторе для сохранения доступа к почтовым папкам целевого пользователя.

Это может использоваться в инцидентах с постоянными угрозами, а также в инцидентах BEC, когда злоумышленник может добавить дополнительные облачные роли к учетным записям, которые он хочет скомпрометировать. Это может позволить использовать дополнительные техники для получения доступа к системам. Например, взломанные бизнес-аккаунты часто используются для отправки сообщений на другие аккаунты в сети целевого предприятия, создавая правила входящих сообщений (например, Internal Spearphishing), чтобы сообщения обходили механизмы обнаружения спама/фишинга.





Дополнительные роли в облаке
------------------------------------------------------------------


Злоумышленник может добавить дополнительные роли или разрешения к контролируемой им учетной записи "облака", чтобы сохранить постоянный доступ к арендатору. Например, злоумышленники могут обновлять политики IAM в облачных средах или добавлять нового глобального администратора в средах Office 365. При наличии достаточных разрешений взломанная учетная запись может получить практически неограниченный доступ к данным и настройкам (включая возможность сбрасывать пароли других администраторов).

Модификация учетной записи может следовать сразу за созданием учетной записи или другими действиями злоумышленников. Злоумышленники также могут изменять существующие действительные учетные записи, которые они скомпрометировали. Это может привести к повышению привилегий, особенно если добавленные роли позволяют перемещаться к дополнительным учетным записям.

Например, в средах AWS злоумышленник с соответствующими полномочиями может использовать API CreatePolicyVersion для определения новой версии политики IAM или API AttachUserPolicy для прикрепления политики IAM с дополнительными или отличными полномочиями к скомпрометированной учетной записи пользователя.





Авторизованные ключи SSH
------------------------------------------------------------------


Злоумышленники могут модифицировать файл SSH authorized_keys, чтобы сохранить его на хосте-жертве. Дистрибутивы Linux и macOS обычно используют аутентификацию на основе ключей для защиты процесса аутентификации в сеансах SSH для удаленного управления. Файл authorized_keys в SSH определяет ключи SSH, которые могут использоваться для входа в учетную запись пользователя, для которого этот файл настроен. Этот файл обычно находится в домашней директории пользователя в каталоге <user-home>/.ssh/authorized_keys. Пользователи могут отредактировать файл конфигурации SSH системы и изменить директивы PubkeyAuthentication и RSAAuthentication на значение "yes", чтобы обеспечить включение аутентификации с открытым ключом и RSA. Файл конфигурации SSH обычно находится в каталоге /etc/ssh/sshd_config.

Злоумышленники могут напрямую изменять файлы SSH authorized_keys с помощью скриптов или команд командной оболочки, чтобы добавить свои собственные открытые ключи, предоставленные противником. В облачных средах злоумышленники могут изменять файл SSH authorized_keys конкретной виртуальной машины через интерфейс командной строки или остальной API. Например, с помощью команды "add-metadata" в Google Cloud CLI злоумышленник может добавить SSH-ключи в учетную запись пользователя.



Регистрация устройства
------------------------------------------------------------------


Недоброжелатели могут зарегистрировать устройство в контролируемой ими учетной записи. Устройства могут быть зарегистрированы в системе многофакторной аутентификации (MFA), которая управляет аутентификацией в сети, или в системе управления устройствами, которая управляет доступом к устройствам и соблюдением требований.

Системы MFA, такие как Duo или Okta, позволяют пользователям ассоциировать устройства со своими учетными записями, чтобы выполнить требования MFA. Злоумышленник, скомпрометировавший учетные данные пользователя, может зарегистрировать новое устройство, чтобы обойти первоначальные требования MFA и получить постоянный доступ к сети. В некоторых случаях процесс самостоятельной регистрации MFA может потребовать только имя пользователя и пароль для регистрации первого устройства учетной записи или для регистрации устройства в неактивной учетной записи. 

Аналогичным образом, злоумышленник, имеющий доступ к сети, может зарегистрировать устройство в Azure AD и/или системе управления устройствами Microsoft Intune, чтобы получить доступ к конфиденциальным данным или ресурсам в обход политик условного доступа.



Дополнительные роли контейнерного кластера
------------------------------------------------------------------


Злоумышленник может добавить дополнительные роли или разрешения к контролируемой злоумышленником учетной записи пользователя или службы, чтобы сохранить постоянный доступ к системе оркестровки контейнеров. Например, злоумышленник с достаточными полномочиями может создать RoleBinding или ClusterRoleBinding для привязки роли или ClusterRole к учетной записи Kubernetes. Если используется контроль доступа на основе атрибутов (ABAC), злоумышленник с достаточными полномочиями может изменить политику Kubernetes ABAC, чтобы предоставить целевой учетной записи дополнительные полномочия.

Такая модификация учетной записи может следовать непосредственно за созданием учетной записи или другими вредоносными действиями с ней. Злоумышленники также могут изменять существующие Valid Accounts, которые они скомпрометировали.

Обратите внимание, что при развертывании систем оркестровки контейнеров в облачных средах, например в Google Kubernetes Engine, Amazon Elastic Kubernetes Service и Azure Kubernetes Service, вместо или в дополнение к локальному назначению разрешений часто используются облачные политики управления доступом на основе ролей (RBAC) В этих случаях данная техника может использоваться в сочетании с Additional Cloud Roles.